# ACTSTAARC-002: Define ActiveState and ActiveStateChanges Types

**Status**: PENDING
**Priority**: HIGH (blocking other tickets)
**Depends On**: ACTSTAARC-001 (TaggedStateEntry types)
**Estimated Scope**: Small

---

## Summary

Define the core data structures for the new Active State system: `ActiveState` (the accumulated state at any point) and `ActiveStateChanges` (the delta generated by each page).

---

## Files to Touch

### Create
- `src/models/state/active-state.ts` - New file with ActiveState types

### Modify
- `src/models/state/index.ts` - Export new types

---

## Out of Scope (DO NOT CHANGE)

- `src/models/state/general-state.ts` - Old types, deprecated separately
- `src/models/state/tagged-entry.ts` - Created in ACTSTAARC-001
- `src/models/page.ts` - Modified in ACTSTAARC-003
- Any prompt files
- Any engine files
- Any persistence files

---

## Implementation Details

### ActiveState Interface

Represents the "truths that are true right now" at any point in the story.

```typescript
import { TaggedStateEntry } from './tagged-entry.js';

export interface ActiveState {
  readonly currentLocation: string;
  readonly activeThreats: readonly TaggedStateEntry[];
  readonly activeConstraints: readonly TaggedStateEntry[];
  readonly openThreads: readonly TaggedStateEntry[];
}
```

### ActiveStateChanges Interface

Represents the changes generated by a single page.

```typescript
export interface ActiveStateChanges {
  readonly newLocation: string | null;  // null = location unchanged
  readonly threatsAdded: readonly string[];    // Raw strings to parse
  readonly threatsRemoved: readonly string[];  // Prefix-only strings
  readonly constraintsAdded: readonly string[];
  readonly constraintsRemoved: readonly string[];
  readonly threadsAdded: readonly string[];
  readonly threadsResolved: readonly string[];
}
```

### Factory Functions

```typescript
export function createEmptyActiveState(): ActiveState {
  return {
    currentLocation: '',
    activeThreats: [],
    activeConstraints: [],
    openThreads: [],
  };
}

export function createEmptyActiveStateChanges(): ActiveStateChanges {
  return {
    newLocation: null,
    threatsAdded: [],
    threatsRemoved: [],
    constraintsAdded: [],
    constraintsRemoved: [],
    threadsAdded: [],
    threadsResolved: [],
  };
}
```

### Type Guards

```typescript
export function isActiveState(value: unknown): value is ActiveState;
export function isActiveStateChanges(value: unknown): value is ActiveStateChanges;
```

---

## Acceptance Criteria

### Tests That Must Pass

Create `test/unit/models/state/active-state-types.test.ts`:

```typescript
describe('createEmptyActiveState', () => {
  it('returns state with empty location', () => {
    const state = createEmptyActiveState();
    expect(state.currentLocation).toBe('');
  });

  it('returns state with empty threat array', () => {
    const state = createEmptyActiveState();
    expect(state.activeThreats).toEqual([]);
  });

  it('returns state with empty constraints array', () => {
    const state = createEmptyActiveState();
    expect(state.activeConstraints).toEqual([]);
  });

  it('returns state with empty threads array', () => {
    const state = createEmptyActiveState();
    expect(state.openThreads).toEqual([]);
  });
});

describe('createEmptyActiveStateChanges', () => {
  it('returns changes with null location', () => {
    const changes = createEmptyActiveStateChanges();
    expect(changes.newLocation).toBeNull();
  });

  it('returns changes with empty arrays', () => {
    const changes = createEmptyActiveStateChanges();
    expect(changes.threatsAdded).toEqual([]);
    expect(changes.threatsRemoved).toEqual([]);
    expect(changes.constraintsAdded).toEqual([]);
    expect(changes.constraintsRemoved).toEqual([]);
    expect(changes.threadsAdded).toEqual([]);
    expect(changes.threadsResolved).toEqual([]);
  });
});

describe('isActiveState', () => {
  it('returns true for valid ActiveState', () => {
    const state: ActiveState = {
      currentLocation: 'Room',
      activeThreats: [],
      activeConstraints: [],
      openThreads: [],
    };
    expect(isActiveState(state)).toBe(true);
  });

  it('returns false for null', () => {
    expect(isActiveState(null)).toBe(false);
  });

  it('returns false for missing currentLocation', () => {
    expect(isActiveState({ activeThreats: [], activeConstraints: [], openThreads: [] })).toBe(false);
  });

  it('returns true for state with entries', () => {
    const state: ActiveState = {
      currentLocation: 'Cave',
      activeThreats: [{ prefix: 'THREAT_X', description: 'X', raw: 'THREAT_X: X' }],
      activeConstraints: [],
      openThreads: [],
    };
    expect(isActiveState(state)).toBe(true);
  });
});

describe('isActiveStateChanges', () => {
  it('returns true for valid changes object', () => {
    const changes: ActiveStateChanges = {
      newLocation: null,
      threatsAdded: [],
      threatsRemoved: [],
      constraintsAdded: [],
      constraintsRemoved: [],
      threadsAdded: [],
      threadsResolved: [],
    };
    expect(isActiveStateChanges(changes)).toBe(true);
  });

  it('returns true when newLocation is string', () => {
    const changes: ActiveStateChanges = {
      newLocation: 'New Place',
      threatsAdded: [],
      threatsRemoved: [],
      constraintsAdded: [],
      constraintsRemoved: [],
      threadsAdded: [],
      threadsResolved: [],
    };
    expect(isActiveStateChanges(changes)).toBe(true);
  });

  it('returns false for missing fields', () => {
    expect(isActiveStateChanges({ newLocation: null })).toBe(false);
  });
});
```

### Invariants That Must Remain True

1. **Immutability**: All properties are `readonly`
2. **Type Safety**: No `any` types in interfaces
3. **Backward Compatibility**: No modifications to existing types
4. **Consistent Naming**: Field names match spec exactly
5. **Location Semantics**: `newLocation: null` means "unchanged", `newLocation: ''` means "explicitly empty"

---

## Definition of Done

- [ ] `src/models/state/active-state.ts` created with all types
- [ ] `src/models/state/index.ts` exports new module
- [ ] All unit tests pass
- [ ] `npm run typecheck` passes
- [ ] `npm run lint` passes
