<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <%- include('../partials/header') %>

  <main>
    <div class="play-container" data-story-id="<%= story.id %>" data-page-id="<%= page.id %>">
      <div class="play-layout">
        <div class="left-sidebar-widgets" id="left-sidebar-widgets">
          <% if (page.protagonistAffect) { %>
          <aside class="affect-panel" id="affect-panel" aria-labelledby="affect-title"
                 data-intensity="<%= page.protagonistAffect.primaryIntensity %>">
            <h3 class="affect-title" id="affect-title">Protagonist</h3>
            <div class="affect-primary">
              <span class="affect-emotion"><%= page.protagonistAffect.primaryEmotion %></span>
              <div class="affect-dots" aria-label="Intensity: <%= page.protagonistAffect.primaryIntensity %>">
                <% var intensityMap = { mild: 1, moderate: 2, strong: 3, overwhelming: 4 }; %>
                <% var filledCount = intensityMap[page.protagonistAffect.primaryIntensity] || 1; %>
                <% for (var d = 0; d < 4; d++) { %>
                <span class="affect-dot<%= d < filledCount ? ' affect-dot--filled' : '' %>"></span>
                <% } %>
                <span class="affect-intensity-label"><%= page.protagonistAffect.primaryIntensity %></span>
              </div>
              <span class="affect-cause"><%= page.protagonistAffect.primaryCause %></span>
            </div>
            <% if (page.protagonistAffect.secondaryEmotions && page.protagonistAffect.secondaryEmotions.length > 0) { %>
            <div class="affect-secondaries">
              <% page.protagonistAffect.secondaryEmotions.forEach(function(se) { %>
              <span class="affect-pill" title="<%= se.cause %>"><%= se.emotion %></span>
              <% }) %>
            </div>
            <% } %>
            <div class="affect-motivation"><%= page.protagonistAffect.dominantMotivation %></div>
          </aside>
          <% } %>

          <% if (npcRelationshipRows && npcRelationshipRows.length > 0) { %>
          <aside class="npc-relationships-panel" id="npc-relationships-panel" aria-labelledby="npc-relationships-title">
            <h3 class="npc-relationships-title" id="npc-relationships-title">NPC Relationships</h3>
            <div class="npc-relationships-content" id="npc-relationships-content">
              <% npcRelationshipRows.forEach((rel) => { %>
              <div class="npc-rel-card" data-npc="<%= rel.npcName %>">
                <div class="npc-rel-header">
                  <span class="npc-rel-name"><%= rel.npcName %></span>
                  <span class="npc-rel-dynamic-pill" title="<%= rel.dynamic %>"><%= rel.dynamic %></span>
                </div>
                <div class="npc-rel-gauge">
                  <div class="npc-rel-gauge-bar">
                    <span class="npc-rel-gauge-marker" style="left: <%= rel.valencePercent %>%"></span>
                  </div>
                </div>
                <div class="npc-rel-details" style="display: none;">
                  <p class="npc-rel-detail"><strong>History:</strong> <%= rel.history %></p>
                  <p class="npc-rel-detail"><strong>Tension:</strong> <%= rel.currentTension %></p>
                  <p class="npc-rel-detail"><strong>Leverage:</strong> <%= rel.leverage %></p>
                </div>
              </div>
              <% }) %>
            </div>
          </aside>
          <% } %>

          <% if (inventoryPanelRows && inventoryPanelRows.length > 0) { %>
          <aside class="inventory-panel" id="inventory-panel" aria-labelledby="inventory-title">
            <h3 class="inventory-title" id="inventory-title">Inventory</h3>
            <ul class="inventory-list" id="inventory-list">
              <% inventoryPanelRows.forEach((item) => { %>
              <li class="inventory-item"><%= item.text %></li>
              <% }) %>
            </ul>
            <% if (inventoryOverflowSummary) { %>
            <div class="keyed-entry-overflow-summary" id="inventory-overflow"><%= inventoryOverflowSummary %></div>
            <% } %>
          </aside>
          <% } %>

          <% if (healthPanelRows && healthPanelRows.length > 0) { %>
          <aside class="health-panel" id="health-panel" aria-labelledby="health-title">
            <h3 class="health-title" id="health-title">Health</h3>
            <ul class="health-list" id="health-list">
              <% healthPanelRows.forEach((item) => { %>
              <li class="health-item"><%= item.text %></li>
              <% }) %>
            </ul>
            <% if (healthOverflowSummary) { %>
            <div class="keyed-entry-overflow-summary" id="health-overflow"><%= healthOverflowSummary %></div>
            <% } %>
          </aside>
          <% } %>

          <button type="button" class="lore-trigger-btn" id="lore-trigger-btn"
                  aria-haspopup="dialog" aria-controls="lore-modal">
            Story Lore
            <span class="lore-count-badge" id="lore-count-badge">
              (<%= (story.globalCanon.length + Object.values(story.globalCharacterCanon).reduce((sum, facts) => sum + facts.length, 0)) %>)
            </span>
          </button>
        </div>

        <div class="play-content">
          <div class="story-header" id="story-header">
            <div class="story-title-section">
              <h2><%= story.title %></h2>
              <% if (actDisplayInfo) { %>
              <div class="act-indicator-wrapper" id="act-indicator-wrapper"
                   data-act-number="<%= actDisplayInfo.actNumber %>">
                <span class="act-indicator act-indicator--clickable" id="act-indicator"
                      role="button" tabindex="0" aria-expanded="false"
                      aria-controls="act-structure-details">
                  <span class="act-indicator__arrow" aria-hidden="true">&#x25B8;</span>
                  <%= actDisplayInfo.displayString %>
                </span>
              </div>
              <% } %>
            </div>
            <div class="story-header-actions" id="story-header-actions">
              <button type="button" class="recap-btn" id="recap-btn"
                      aria-haspopup="dialog" aria-controls="recap-modal">
                <span class="recap-btn__icon" aria-hidden="true">&#x1f4dc;</span>
                <span class="recap-btn__label">Story So Far</span>
              </button>
              <% if (page.analystResult) { %>
              <button type="button" class="insights-btn" id="insights-btn" aria-haspopup="dialog" aria-controls="insights-modal">
                <span class="insights-btn__icon" aria-hidden="true">üîç</span>
                <span class="insights-btn__label">Story Insights</span>
              </button>
              <% } %>
              <span class="page-indicator">Page <%= page.id %></span>
            </div>
          </div>

          <% if (actDisplayInfo && (actDisplayInfo.actObjective || actDisplayInfo.actStakes || actDisplayInfo.beatObjective)) { %>
          <div class="act-structure-details" id="act-structure-details" hidden>
            <% if (actDisplayInfo.actObjective) { %>
            <div class="act-structure-details__item">
              <span class="act-structure-details__label">Act Objective</span>
              <span class="act-structure-details__text"><%= actDisplayInfo.actObjective %></span>
            </div>
            <% } %>
            <% if (actDisplayInfo.actStakes) { %>
            <div class="act-structure-details__item">
              <span class="act-structure-details__label">Stakes</span>
              <span class="act-structure-details__text"><%= actDisplayInfo.actStakes %></span>
            </div>
            <% } %>
            <% if (actDisplayInfo.beatObjective) { %>
            <div class="act-structure-details__item">
              <span class="act-structure-details__label">Beat Objective</span>
              <span class="act-structure-details__text"><%= actDisplayInfo.beatObjective %></span>
            </div>
            <% } %>
          </div>
          <% } %>

          <article class="narrative" id="narrative">
            <div class="narrative-text">
              <%- page.narrativeText.replace(/\n/g, '<br>') %>
            </div>
          </article>

          <% if (page.stateChanges && page.stateChanges.length > 0) { %>
          <aside class="state-changes" id="state-changes">
            <h4>What happened:</h4>
            <ul>
              <% page.stateChanges.forEach(change => { %>
              <li><%= change %></li>
              <% }) %>
            </ul>
          </aside>
          <% } %>

          <% if (page.isEnding) { %>
          <div class="ending-banner">
            <h3>THE END</h3>
            <div class="ending-actions">
              <a href="/play/<%= story.id %>/restart" class="btn btn-primary">Play Again</a>
              <a href="/" class="btn btn-secondary">Back to Stories</a>
            </div>
          </div>
          <% } else { %>
          <section class="choices-section" id="choices-section">
            <h3>What do you do?</h3>
            <div class="choices" id="choices">
              <% page.choices.forEach((choice, index) => { %>
              <div class="choice-row">
                <span class="choice-icon-pill" aria-hidden="true">
                  <img class="choice-icon choice-icon--type"
                       src="/images/icons/<%= choice.choiceType.toLowerCase().replace(/_/g, '-') %>.png"
                       alt=""
                       title="<%= choiceTypeLabels[choice.choiceType] ? choiceTypeLabels[choice.choiceType].label : '' %>"
                       width="32" height="32" loading="lazy"
                       onerror="this.style.display='none'">
                  <img class="choice-icon choice-icon--delta"
                       src="/images/icons/<%= choice.primaryDelta.toLowerCase().replace(/_/g, '-') %>.png"
                       alt=""
                       title="<%= primaryDeltaLabels[choice.primaryDelta] || '' %>"
                       width="32" height="32" loading="lazy"
                       onerror="this.style.display='none'">
                </span>
                <button
                  class="choice-btn"
                  data-choice-index="<%= index %>"
                  data-choice-type="<%= choice.choiceType %>"
                  data-primary-delta="<%= choice.primaryDelta %>"
                  <%= choice.nextPageId ? 'data-explored="true"' : '' %>
                >
                  <span class="choice-text"><%= choice.text %></span>
                </button>
                <% if (choice.nextPageId) { %>
                <span class="explored-marker" title="Previously explored">&#8617;</span>
                <% } %>
              </div>
              <% }) %>
            </div>
            <details class="protagonist-guidance">
              <summary class="protagonist-guidance__summary">Guide Your Protagonist</summary>
              <div class="protagonist-guidance__fields">
                <div class="protagonist-guidance__field">
                  <label class="protagonist-guidance__label" for="guidance-emotions">Emotions</label>
                  <textarea
                    id="guidance-emotions"
                    class="protagonist-guidance__textarea"
                    name="suggestedEmotions"
                    placeholder="e.g. Furious but hiding it behind a thin smile..."
                    maxlength="500"
                    rows="2"
                  ></textarea>
                </div>
                <div class="protagonist-guidance__field">
                  <label class="protagonist-guidance__label" for="guidance-thoughts">Thoughts</label>
                  <textarea
                    id="guidance-thoughts"
                    class="protagonist-guidance__textarea"
                    name="suggestedThoughts"
                    placeholder="e.g. Wondering if the stranger recognized them..."
                    maxlength="500"
                    rows="2"
                  ></textarea>
                </div>
                <div class="protagonist-guidance__field">
                  <label class="protagonist-guidance__label" for="guidance-speech">Speech</label>
                  <textarea
                    id="guidance-speech"
                    class="protagonist-guidance__textarea"
                    name="suggestedSpeech"
                    placeholder="e.g. 'Wake up, Alicia! We don't have much time.'"
                    maxlength="500"
                    rows="2"
                  ></textarea>
                </div>
              </div>
            </details>
            <div class="custom-choice-container">
              <input type="text" class="custom-choice-input"
                     placeholder="Introduce your own custom choice..."
                     maxlength="500" />
              <button type="button" class="custom-choice-btn">Add</button>
            </div>
            <div class="custom-choice-enums">
              <select class="custom-choice-type">
                <option value="TACTICAL_APPROACH">Method/Tactic</option>
                <option value="MORAL_DILEMMA">Moral Choice</option>
                <option value="IDENTITY_EXPRESSION">Define Yourself</option>
                <option value="RELATIONSHIP_SHIFT">Relationship</option>
                <option value="RESOURCE_COMMITMENT">Spend/Risk</option>
                <option value="INVESTIGATION">Investigate</option>
                <option value="PATH_DIVERGENCE">Change Direction</option>
                <option value="CONFRONTATION">Confront/Fight</option>
                <option value="AVOIDANCE_RETREAT">Avoid/Flee</option>
              </select>
              <select class="custom-choice-delta">
                <option value="LOCATION_CHANGE">Location</option>
                <option value="GOAL_SHIFT">Goal</option>
                <option value="RELATIONSHIP_CHANGE">Relationship</option>
                <option value="URGENCY_CHANGE">Time Pressure</option>
                <option value="ITEM_CONTROL">Item</option>
                <option value="EXPOSURE_CHANGE">Attention</option>
                <option value="CONDITION_CHANGE">Condition</option>
                <option value="INFORMATION_REVEALED">Information</option>
                <option value="THREAT_SHIFT">Danger</option>
                <option value="CONSTRAINT_CHANGE">Limitation</option>
              </select>
            </div>
            <div class="alert alert-error play-error" id="play-error" style="display: none;" role="alert" aria-live="polite"></div>
          </section>
          <% } %>
        </div>

        <div class="sidebar-widgets" id="sidebar-widgets">
          <% if (openThreadPanelRows && openThreadPanelRows.length > 0) { %>
          <aside class="open-threads-panel" id="open-threads-panel" aria-labelledby="open-threads-title">
            <h3 class="open-threads-title" id="open-threads-title">Active Threads</h3>
            <ul class="open-threads-list" id="open-threads-list">
              <% openThreadPanelRows.forEach((thread) => { %>
              <li class="open-threads-item">
                <span class="thread-icon-pill" aria-hidden="true">
                  <span class="thread-icon-badge">
                    <img class="thread-icon"
                         src="/images/icons/thread-<%= thread.threadType.toLowerCase() %>-<%= thread.urgency.toLowerCase() %>.png"
                         alt=""
                         title="<%= thread.threadType %> (<%= thread.urgency %>)"
                         loading="lazy"
                         onerror="this.style.display='none'">
                  </span>
                </span>
                <span class="open-threads-text open-threads-text--<%= thread.urgency.toLowerCase().replace(/_/g, '-') %>"><%= thread.text %></span>
              </li>
              <% }) %>
            </ul>
            <% if (openThreadOverflowSummary) { %>
            <div class="open-threads-overflow-summary" id="open-threads-overflow-summary"><%= openThreadOverflowSummary %></div>
            <% } %>
          </aside>
          <% } %>

          <% if (threatsPanelRows && threatsPanelRows.length > 0) { %>
          <aside class="active-threats-panel" id="active-threats-panel" aria-labelledby="active-threats-title">
            <h3 class="active-threats-title" id="active-threats-title">Active Threats</h3>
            <ul class="active-threats-list" id="active-threats-list">
              <% threatsPanelRows.forEach((threat) => { %>
              <li class="active-threats-item">
                <span class="thread-icon-pill" aria-hidden="true">
                  <span class="thread-icon-badge thread-icon-badge--type thread-icon-badge--threat">
                    <img class="thread-icon thread-icon--type thread-icon--threat"
                         src="/images/icons/threat-<%= threat.threatType.toLowerCase().replace(/_/g, '-') %>.png"
                         alt=""
                         title="<%= threat.threatType %>"
                         loading="lazy"
                         onerror="this.style.display='none'">
                  </span>
                </span>
                <span><%= threat.text %></span>
              </li>
              <% }) %>
            </ul>
            <% if (threatsOverflowSummary) { %>
            <div class="keyed-entry-overflow-summary" id="active-threats-overflow"><%= threatsOverflowSummary %></div>
            <% } %>
          </aside>
          <% } %>

          <% if (constraintsPanelRows && constraintsPanelRows.length > 0) { %>
          <aside class="active-constraints-panel" id="active-constraints-panel" aria-labelledby="active-constraints-title">
            <h3 class="active-constraints-title" id="active-constraints-title">Active Constraints</h3>
            <ul class="active-constraints-list" id="active-constraints-list">
              <% constraintsPanelRows.forEach((constraint) => { %>
              <li class="active-constraints-item">
                <span class="thread-icon-pill" aria-hidden="true">
                  <span class="thread-icon-badge thread-icon-badge--type">
                    <img class="thread-icon thread-icon--type"
                         src="/images/icons/constraint-<%= constraint.constraintType.toLowerCase().replace(/_/g, '-') %>.png"
                         alt=""
                         title="<%= constraint.constraintType %>"
                         loading="lazy"
                         onerror="this.style.display='none'">
                  </span>
                </span>
                <span><%= constraint.text %></span>
              </li>
              <% }) %>
            </ul>
            <% if (constraintsOverflowSummary) { %>
            <div class="keyed-entry-overflow-summary" id="active-constraints-overflow"><%= constraintsOverflowSummary %></div>
            <% } %>
          </aside>
          <% } %>

          <% if (trackedPromisesPanelRows && trackedPromisesPanelRows.length > 0) { %>
          <aside class="tracked-promises-panel" id="tracked-promises-panel" aria-labelledby="tracked-promises-title">
            <h3 class="tracked-promises-title" id="tracked-promises-title">Tracked Promises</h3>
            <ul class="tracked-promises-list" id="tracked-promises-list">
              <% trackedPromisesPanelRows.forEach((promise) => { %>
              <li class="tracked-promises-item">
                <span class="promise-type-text-badge"><%= promise.promiseType.toLowerCase().split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') %></span>
                <span class="promise-age-badge"><%= promise.age %> pg</span>
                <span><%= promise.text %></span>
              </li>
              <% }) %>
            </ul>
            <% if (trackedPromisesOverflowSummary) { %>
            <div class="keyed-entry-overflow-summary" id="tracked-promises-overflow"><%= trackedPromisesOverflowSummary %></div>
            <% } %>
          </aside>
          <% } %>
        </div>
      </div>

      <div class="loading-overlay" id="loading" style="display: none;">
        <div class="loading-stage" aria-live="polite"></div>
        <div class="loading-spinner"></div>
        <p class="loading-status">Crafting your story...</p>
      </div>

      <div class="modal" id="api-key-modal" style="display: none;">
        <div class="modal-content">
          <h3>Enter OpenRouter API Key</h3>
          <p>Your API key is needed to generate new story content.</p>
          <form id="api-key-form" class="api-key-form">
            <input type="password" id="modal-api-key" placeholder="sk-or-..." autocomplete="off">
            <div class="modal-actions">
              <button class="btn btn-primary" id="save-api-key" type="submit">Continue</button>
              <a href="/" class="btn btn-secondary">Cancel</a>
            </div>
          </form>
        </div>
      </div>

      <div class="modal insights-modal" id="insights-modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="insights-modal-title">
        <div class="modal-content insights-modal-content">
          <div class="insights-header">
            <h3 id="insights-modal-title">Story Insights</h3>
            <button type="button" class="insights-close-btn" id="insights-close-btn" aria-label="Close Story Insights">&times;</button>
          </div>
          <div class="insights-body" id="insights-modal-body"></div>
        </div>
      </div>

      <div class="modal recap-modal" id="recap-modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="recap-modal-title">
        <div class="modal-content recap-modal-content">
          <div class="recap-header">
            <h3 id="recap-modal-title">The Story So Far</h3>
            <button type="button" class="recap-close-btn" id="recap-close-btn" aria-label="Close Story Recap">&times;</button>
          </div>
          <div class="recap-body" id="recap-modal-body"></div>
        </div>
      </div>

      <div class="modal lore-modal" id="lore-modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="lore-modal-title">
        <div class="modal-content lore-modal-content">
          <div class="lore-header">
            <h3 id="lore-modal-title">Story Lore</h3>
            <button type="button" class="lore-close-btn" id="lore-close-btn" aria-label="Close Story Lore">&times;</button>
          </div>
          <div class="lore-tabs" role="tablist">
            <button class="lore-tab lore-tab--active" role="tab" aria-selected="true"
                    data-tab="world" id="lore-tab-world"
                    aria-controls="lore-panel-world">World</button>
            <button class="lore-tab" role="tab" aria-selected="false"
                    data-tab="characters" id="lore-tab-characters"
                    aria-controls="lore-panel-characters">Characters</button>
          </div>
          <div class="lore-body" id="lore-modal-body">
            <div class="lore-tab-panel" id="lore-panel-world"
                 role="tabpanel" aria-labelledby="lore-tab-world"></div>
            <div class="lore-tab-panel" id="lore-panel-characters"
                 role="tabpanel" aria-labelledby="lore-tab-characters"
                 style="display: none;"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <%- include('../partials/footer') %>

  <script type="application/json" id="analyst-data"><%- JSON.stringify(page.analystResult ?? null) %></script>
  <script type="application/json" id="insights-context"><%- JSON.stringify({ actDisplayInfo: actDisplayInfo ? actDisplayInfo.displayString : null, sceneSummary: page.sceneSummary ?? null, resolvedThreadMeta: insightsThreadMeta ?? {}, resolvedPromiseMeta: page.resolvedPromiseMeta ?? {} }) %></script>
  <script type="application/json" id="recap-data"><%- JSON.stringify(recapSummaries ?? []) %></script>
  <script type="application/json" id="lore-data"><%- JSON.stringify({ worldFacts: story.globalCanon, characterCanon: story.globalCharacterCanon }) %></script>
  <script src="/js/app.js"></script>
</body>
</html>
