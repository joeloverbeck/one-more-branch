  // ── Configuration ──────────────────────────────────────────────────

  const API_KEY_STORAGE_KEY = 'omb_api_key';
  const PROGRESS_POLL_INTERVAL_MS = 1200;
  const PHRASE_ROTATION_MIN_MS = 3500;
  const PHRASE_ROTATION_MAX_MS = 4500;
  const OPEN_THREADS_PANEL_LIMIT = 6;

  const STAGE_PHRASE_POOLS = {
    PLANNING_PAGE: [
      'Consulting the crystal flowchart...',
      'Drawing arrows between dramatic possibilities...',
      'Balancing destiny on a clipboard...',
      'Whispering to the page planner gremlins...',
      'Calling a meeting of the tiny committee in the wall...',
      'Spinning the wheel of plausible chaos...',
      'Asking the couch cushions for strategic advice...',
      'Filing a permit for emotional turbulence...',
      'Color-coding fate with suspicious confidence...',
      'Unfolding the emergency roadmap of maybes...',
      'Negotiating with the timeline using snacks...',
      'Pinning red string to absolutely everything...',
      'Rolling percentile dice for narrative nonsense...',
      'Drafting plans in invisible ink and optimism...',
      'Testing three plans and a backup plan for the backup...',
      'Summoning a brainstorming thundercloud...',
      'Aligning plot magnets to true north drama...',
      'Cross-referencing vibes with hard evidence...',
      'Sharpening pencils to a tactical point...',
      'Budgeting exactly seven units of suspense...',
      'Interviewing three raccoons about long-term strategy...',
      'Mapping alternate futures on a napkin atlas...',
      'Counting plot beats with abacus-level confidence...',
      'Assembling a task force of overqualified pigeons...',
      'Translating chaos into bullet points and coffee rings...',
      'Scheduling destiny in 15-minute calendar blocks...',
      'Running a tabletop exercise for worst-case melodrama...',
      'Tuning the risk radar to "politely catastrophic"...',
      'Checking if the backup prophecy has a backup...',
      'Building a tiny model of the plot out of cereal...',
      'Holding auditions for the next big complication...',
      'Labeling each possibility with a caution sticker...',
      'Comparing timelines for structural squeaks...',
      'Drafting contingency plans on the back of moonlight...',
      'Assigning cliffhangers to their proper jurisdictions...',
      'Sending reconnaissance balloons into chapter two...',
      'Running cost estimates on emotional collateral...',
      'Verifying assumptions with a dramatic checklist...',
      'Plotting escape routes from predictable outcomes...',
      'Stress-testing Plan A against the laws of irony...',
      'Calculating odds with a haunted spreadsheet...',
      'Summoning a consultant possum for tactical input...',
      'Folding contingency plans into paper airplanes...',
      'Checking whether destiny signed the waiver...',
      'Setting up cones around high-risk plot zones...',
      'Feeding strategy grapes to the idea committee...',
      'Using divining rods to locate hidden opportunities...',
      'Building a decision tree out of toothpicks...',
      'Forecasting drama with a barometer and vibes...',
      'Asking the office fern to rank our options...',
      'Air-dropping priorities into a sandbox of chaos...',
      'Measuring uncertainty in teaspoons and sighs...',
      'Consulting the emergency binder labeled "yikes"...',
      'Running a war game with tiny cardboard villains...',
      'Assigning probability hats to every wild guess...',
      'Negotiating timeline treaties at the snack table...',
      'Drafting scenario maps with glitter pens only...',
      'Shuffling strategic options like tarot cards...',
      'Placing caution tape around suspiciously easy plans...',
      'Checking if fate left comments on the whiteboard...',
    ],
    CURATING_CONTEXT: [
      'Consulting the ancient tomes...',
      'Cross-referencing character grudges...',
      'Alphabetizing plot threads by urgency...',
      'Dusting off the relevant lore scrolls...',
      'Cataloging who knows what and why...',
      'Filing canon facts by scene relevance...',
      'Sifting through backstory for gold...',
      'Indexing every grudge, oath, and rumor...',
      'Sorting character baggage by weight...',
      'Highlighting the bits that actually matter...',
      'Trimming the lore hedge into shape...',
      'Cross-checking alibis with established canon...',
      'Retrieving the right dossiers from the vault...',
      'Marking worldbuilding passages for inclusion...',
      'Shelving irrelevant details with a polite nod...',
      'Assembling the scene-specific cheat sheet...',
      'Pulling character files from the archive...',
      'Condensing three volumes into one sticky note...',
      'Verifying which NPCs are in the room...',
      'Building a relationship map out of red string...',
      'Checking speech patterns against dialogue records...',
      'Curating only the juiciest canon facts...',
      'Reviewing who said what to whom and when...',
      'Extracting verbal tics from prior conversations...',
      'Filtering worldbuilding through the scene lens...',
      'Packaging emotional baggage for scene delivery...',
      'Compiling a dossier of relevant tensions...',
      'Tagging characters by scene importance...',
      'Archiving the stuff nobody needs right now...',
      'Preparing the scene-focused briefing packet...',
      'Auditing character relationships for freshness...',
      'Sorting history into chronological cause-and-effect...',
      'Stamping canon facts with relevance ratings...',
      'Rolling up lore into a portable scroll...',
      'Pruning the context garden of decorative weeds...',
      'Assembling the cast list for this scene...',
      'Verifying continuity seals are unbroken...',
      'Checking which promises are due this chapter...',
      'Building the scene bible with archival precision...',
      'Extracting only the load-bearing lore...',
      'Selecting the right emotional ammunition...',
      'Summarizing three acts of history in two paragraphs...',
      'Folding context into an origami cheat sheet...',
      'Organizing character dynamics by voltage level...',
      'Labeling each fact by expiration scene...',
      'Pulling relevant memories from the narrative vault...',
      'Scanning the timeline for causality chains...',
      'Compressing epic backstory into scene-sized packets...',
      'Cross-referencing motives with opportunity...',
      'Sorting the important from the merely interesting...',
      'Weighing each detail on the relevance scale...',
      'Assembling a greatest-hits of narrative context...',
      'Checking which character arcs are load-bearing...',
      'Preparing a briefcase of curated consequences...',
      'Filing emotional receipts by character name...',
      'Distilling worldbuilding into scene-grade concentrate...',
      'Reviewing the interpersonal tension inventory...',
      'Selecting speech samples for voice consistency...',
      'Packaging the past into a useful present...',
    ],
    WRITING_OPENING_PAGE: [
      'Rolling out the opening scene carpet...',
      'Polishing first impressions with glitter...',
      'Cueing the cinematic entrance music...',
      'Placing the camera at maximum drama angle...',
      'Turning on the fog machine for ambience...',
      'Teaching the narrator to make eye contact...',
      'Warming up the dialogue with tongue twisters...',
      'Deploying tasteful thunder in the distance...',
      'Adjusting the spotlight to "mysterious but friendly"...',
      'Setting out fresh metaphors in a neat row...',
      'Tuning the opening line to perfect pitch...',
      'Adding one dramatic pause for seasoning...',
      'Sweeping confetti off the exposition runway...',
      'Calibrating the first sentence launch sequence...',
      'Installing mood lighting in paragraph one...',
      'Bribing the hook to land cleanly...',
      'Giving the protagonist a very determined eyebrow...',
      'Pressing record on the cinematic narrator voice...',
      'Rehearsing the first reveal with jazz hands...',
      'Opening the curtain on controlled narrative chaos...',
      'Unboxing the very first sentence with white gloves...',
      'Loading the intro cannon with premium intrigue...',
      'Hanging a neon sign that says "pay attention"...',
      'Deploying a carefully trained opening gasp...',
      'Teaching paragraph one how to strut confidently...',
      'Spritzing the scene with fresh-pressed atmosphere...',
      'Dialing the narrative camera to impossible close-up...',
      'Placing a breadcrumb trail of irresistible questions...',
      'Testing the hook on a focus group of daydreamers...',
      'Repainting the sky in chapter-one colors...',
      'Priming the conflict engine for immediate ignition...',
      'Adding velvet ropes around the first big reveal...',
      'Handing the narrator a megaphone and a secret...',
      'Sculpting the opening beat with dramatic chisels...',
      'Letting the first line do one theatrical bow...',
      'Tightening the intro knots with narrative pliers...',
      'Positioning the stakes where everyone can trip on them...',
      'Charging the prologue batteries to 100 percent...',
      'Inviting curiosity to kick down the front door...',
      'Setting the tone dial to "you are now invested"...',
      'Sending the opening shot through a glamour filter...',
      'Preheating the first page to cinematic temperature...',
      'Waxing the runway for a dramatic character entrance...',
      'Packing the intro with legally approved goosebumps...',
      'Cueing a choir of suspiciously relevant violins...',
      'Teaching the first paragraph to wink at the reader...',
      'Unleashing a tiny stampede of immediate questions...',
      'Giving the hook a cape and excellent timing...',
      'Rolling out red carpet for the inciting incident...',
      'Polishing the premise until it catches moonlight...',
      'Adjusting atmosphere levels to "electric storm"...',
      'Planting one breadcrumb and seven complications...',
      'Sneaking tension into the room through the vents...',
      'Ironing the opening beats until they snap...',
      'Installing fireworks behind the first reveal...',
      'Teaching chapter one to kick the door in politely...',
      'Loading the scene with premium-grade anticipation...',
      'Strapping a rocket booster to the first conflict...',
      'Rehearsing the cold open with dramatic fanfare...',
      'Spiking the intro punch bowl with intrigue...',
    ],
    WRITING_CONTINUING_PAGE: [
      'Stitching consequences into the timeline...',
      'Keeping the plot train barely on the rails...',
      'Handing the scene to the next narrator...',
      'Adding one more suspiciously perfect twist...',
      'Refueling the momentum engine with cliffhangers...',
      'Untangling side quests from the chandelier...',
      'Passing notes between cause and effect...',
      'Patching continuity leaks with narrative gum...',
      'Setting the stakes to "gently terrifying"...',
      'Rotating the mystery box for better suspense...',
      'Escorting loose ends toward responsible adulthood...',
      'Threading foreshadowing through a tiny needle...',
      'Bolting the midpoint together with dramatic screws...',
      'Checking the subplot humidity levels...',
      'Giving consequences room to breathe ominously...',
      'Synchronizing character arcs with the moon phase...',
      'Reheating tension until pleasantly unstable...',
      'Guiding the pacing with a traffic baton...',
      'Sliding the dominoes into place with tweezers...',
      'Issuing plot passports for cross-scene travel...',
      'Escorting momentum past the valley of distractions...',
      'Tightening cause-and-effect with a torque wrench...',
      'Stacking fresh dilemmas like unstable pancakes...',
      'Refilling the tension reservoir one drop at a time...',
      'Sending character decisions through quality control...',
      'Keeping the subplot orchestra in the same tempo...',
      'Shoveling narrative coal into the third-act furnace...',
      'Documenting every consequence for legal reasons...',
      'Steering this chapter through emotional weather...',
      'Balancing revelations on a very narrow shelf...',
      'Adding controlled sparks to the conflict wiring...',
      'Rotating viewpoints to prevent dramatic traffic jams...',
      'Escalating stakes with OSHA-compliant urgency...',
      'Fastening the next beat with industrial foreshadowing...',
      'Checking dialogue pressure before the next release...',
      'Threading payoffs through active construction zones...',
      'Keeping the emotional RPMs in the red...',
      'Redirecting loose chaos into productive chaos...',
      'Feeding the suspense creature on a strict schedule...',
      'Escorting every choice toward glorious consequences...',
      'Passing the scene baton without dropping any secrets...',
      'Inflating the conflict balloon to optimal squeak...',
      'Splicing fresh momentum into the narrative bloodstream...',
      'Escorting revelations through a crowded hallway...',
      'Tightening suspense screws until they hum...',
      'Giving the stakes a double shot of espresso...',
      'Laying banana peels in front of bad decisions...',
      'Sweeping emotional shrapnel into future chapters...',
      'Keeping the tension kite aloft in crosswinds...',
      'Threading character growth through laser grids...',
      'Adding speed bumps before every easy answer...',
      'Scheduling consequences for prime-time impact...',
      'Greasing the plot gears with dramatic irony...',
      'Rolling the next complication down a marble track...',
      'Letting the subtext simmer on low chaos...',
      'Installing handrails on this slippery escalation...',
      'Routing every shortcut straight into trouble...',
      'Pressurizing the next beat for maximum pop...',
      'Funneling uncertainty into a very loud maybe...',
      'Keeping this chapter one decision away from disaster...',
    ],
    ANALYZING_SCENE: [
      'Checking the scene for narrative wobble...',
      'Comparing outcomes with the prophecy chart...',
      'Scanning for hidden cause-and-effect crumbs...',
      'Measuring tension levels with a tiny ruler...',
      'Dusting the clues for emotional fingerprints...',
      'Listening for suspiciously meaningful silence...',
      'Highlighting motifs in five shades of concern...',
      'Interrogating the subtext under bright lights...',
      'Charting who knows what on a corkboard...',
      'Running diagnostics on dramatic timing...',
      'Counting unresolved questions on both hands...',
      'Testing each beat for maximum narrative bounce...',
      'Inspecting dialogue for secret trapdoors...',
      'Triangulating intent, action, and fallout...',
      'Separating facts from very confident guesses...',
      'Scanning the room for Chekhov objects...',
      'Stress-testing the logic with a rubber hammer...',
      'Weighing emotional impact on calibrated scales...',
      'Decoding facial expressions into strategic data...',
      'Marking potential plot potholes with neon flags...',
      'Running forensic tests on suspicious adverbs...',
      'Cross-examining every beat for motive and means...',
      'Measuring subtext depth with sonar equipment...',
      'Cataloging narrative anomalies by timestamp...',
      'Comparing stated goals to actual chaos produced...',
      'Tracing dramatic footprints across the scene floor...',
      'Stress-auditing every reaction for plausibility...',
      'Triaging unresolved tension by urgency level...',
      'Putting each line under a microscope of intent...',
      'Building an evidence board out of eyebrow raises...',
      'Searching for quiet details doing loud work...',
      'Tagging emotional pivots with forensic tape...',
      'Verifying that every reveal earns its oxygen...',
      'Checking continuity seams for daylight leaks...',
      'Profiling conflict patterns for repeat offenders...',
      'Testing interpretation theories in a wind tunnel...',
      'Flagging dialogue that knows too much too soon...',
      'Auditing who changed, why, and at what cost...',
      'Reconstructing the scene from consequence fragments...',
      'Checking whether the silence says more than the speech...',
      'Running motive prints through the clue database...',
      'Timing each pause with a suspense stopwatch...',
      'Sampling the vibe for trace amounts of foreshadowing...',
      'Inspecting reactions for counterfeit confidence...',
      'Charting emotional weather by line and gesture...',
      'Testing every alibi under a hot desk lamp...',
      'Mapping power shifts with tiny magnetic arrows...',
      'Verifying who blinked first and why...',
      'Sifting dialogue sediment for hidden gold...',
      'Comparing what was said to what was swallowed...',
      'X-raying the scene for concealed turning points...',
      'Measuring dramatic friction with calibrated gloves...',
      'Isolating the exact moment the room changed shape...',
      'Tagging suspicious coincidences for lab review...',
      'Checking whether each choice leaves a footprint...',
      'Triangulating tension from tone, timing, and eye contact...',
      'Profiling every beat for intent-to-impact ratio...',
      'Stress-testing assumptions against inconvenient facts...',
      'Pinning red yarn between questions and consequences...',
      'Auditing the unspoken stuff for maximum significance...',
    ],
    RESTRUCTURING_STORY: [
      'Rearranging story beams without waking dragons...',
      'Tightening bolts on the adventure skeleton...',
      'Re-threading plot cables behind the walls...',
      'Deploying emergency structure duct tape...',
      'Moving chapter furniture with narrative dollies...',
      'Replacing squeaky scenes with reinforced tension...',
      'Installing support arcs under weak spots...',
      'Rerouting character traffic to reduce pileups...',
      'Welding the midpoint to the ending frame...',
      'Stacking stakes where they can do the most damage...',
      'Refitting transitions with smoother gears...',
      'Laying fresh track for the final act train...',
      'Demolishing one wobbly beat at a safe distance...',
      'Reinforcing the foundation with consequence cement...',
      'Hoisting the payoff into load-bearing position...',
      'Rebalancing the structure for emotional wind...',
      'Rewiring callbacks to the main power grid...',
      'Swapping in a sturdier sequence of events...',
      'Labeling every moving part "fragile but important"...',
      'Running final inspections with a hard hat...',
      'Relocating major twists to safer load-bearing chapters...',
      'Installing seismic braces for surprise reveals...',
      'Regrading the slope so tension flows downhill...',
      'Replacing narrative scaffolding with permanent supports...',
      'Cutting new doorways between disconnected scenes...',
      'Rebalancing act breaks to avoid dramatic sinkholes...',
      'Retrofitting the climax with reinforced cause-and-effect...',
      'Demoting decorative detours to optional side streets...',
      'Rerouting exposition through cleaner pipelines...',
      'Re-centering the core conflict on solid bedrock...',
      'Lifting sagging subplots with hydraulic jacks...',
      'Refitting the opening so the ending actually fits...',
      'Realigning chapter joints for smoother movement...',
      'Bolstering weak transitions with structural callbacks...',
      'Converting dead-end beats into through-lines...',
      'Consolidating duplicate conflicts into one heavy hitter...',
      'Replacing narrative bloat with precision-engineered stakes...',
      'Moving the emotional keystone back into place...',
      'Repainting the whole arc with clearer contrast...',
      'Running a full structural scan before reopening...',
      'Installing shock absorbers on every major twist...',
      'Redistributing weight away from the saggy middle...',
      'Replacing decorative scenes with load-bearing drama...',
      'Threading steel cables through the act breaks...',
      'Reinforcing weak joints with callback brackets...',
      'Rebuilding the climax staircase to code...',
      'Moving exposition crates off emergency exits...',
      'Swapping brittle beats for tempered story glass...',
      'Pouring fresh concrete under the central conflict...',
      'Converting narrative dead space into useful corridors...',
      'Retensioning the arc so it does not wobble...',
      'Installing pressure valves for high-stakes moments...',
      'Aligning every subplot gear with the master crank...',
      'Reframing chapter walls to fit bigger payoffs...',
      'Replacing mystery drywall with transparent intent...',
      'Upgrading transitions from rope bridge to highway...',
      'Hoisting delayed consequences into plain view...',
      'Routing emotional load through stronger pillars...',
      'Removing decorative scaffolds still pretending to be scenes...',
      'Checking the whole structure for sequel-proof stability...',
    ],
    RESOLVING_AGENDAS: [
      'Eavesdropping on NPCs whispering behind closed doors...',
      'Reviewing everyone\'s secret diary entries...',
      'Tracking who stabbed whom in the back today...',
      'Calculating grudge interest rates...',
      'Checking which NPCs are plotting revenge...',
      'Updating the grudge board with fresh pins...',
      'Listening at keyholes for nefarious scheming...',
      'Tallying up who owes favors to whom...',
      'Unfolding a corkboard of overlapping schemes...',
      'Cataloging side-eye incidents for future reference...',
      'Intercepting coded notes between shady allies...',
      'Checking whether anyone upgraded their backstabbing gear...',
      'Reviewing minutes from the secret villains\' brunch...',
      'Counting how many NPCs muttered "soon" this chapter...',
      'Auditing off-screen mischief reports...',
      'Filing incident reports for unsanctioned scheming...',
      'Measuring the ambient levels of treachery...',
      'Polling NPCs on their current treachery satisfaction...',
      'Cross-referencing alibis with suspicious absences...',
      'Recalculating everyone\'s loyalty scores...',
      'Monitoring the rumor mill for fresh gossip...',
      'Updating the conspiracy flowchart...',
      'Checking which NPCs have been pacing suspiciously...',
      'Reviewing blackmail material inventories...',
      'Verifying whether anyone sent ravens this turn...',
      'Scanning for dramatic monologue rehearsals...',
      'Adjusting NPC ambition sliders...',
      'Cataloging nervous glances exchanged this chapter...',
      'Running background checks on everyone\'s motives...',
      'Noting which NPCs smiled at the wrong moment...',
      'Tabulating petty feuds and ancient grudges...',
      'Sorting agendas by desperation level...',
      'Checking who\'s been sharpening metaphorical knives...',
      'Decoding passive-aggressive gift exchanges...',
      'Reviewing who has been suspiciously helpful lately...',
      'Evaluating the off-screen power shuffle...',
      'Tracking alliance formation and betrayal timelines...',
      'Checking which NPCs have contingency plans...',
      'Measuring fear levels against leverage ratios...',
      'Updating the "Who Wants What" spreadsheet...',
      'Intercepting a messenger pigeon with interesting news...',
      'Analyzing NPC body language from last scene...',
      'Checking if any NPCs have developed new anxieties...',
      'Reviewing the NPC suggestion box...',
      'Detecting a shift in the balance of scheming...',
      'Comparing stated intentions with actual behavior...',
      'Auditing the NPC snack cabinet for stress eating...',
      'Marking territories on the political influence map...',
      'Checking if anyone moved their chess pieces overnight...',
      'Reviewing suspicious purchases from the last chapter...',
      'Verifying that no one switched sides during the break...',
      'Running a threat assessment on recent compliments...',
      'Cataloging unfinished sentences and loaded pauses...',
      'Checking for unsigned letters slid under doors...',
      'Recalculating the probability of betrayal per NPC...',
      'Reviewing who has been making too many promises...',
      'Tracking which NPCs avoided eye contact this scene...',
      'Flagging characters with implausibly clean hands...',
      'Noting who laughed a little too long at dinner...',
      'Updating the off-screen activity ledger...',
    ],
  };
  const STAGE_DISPLAY_NAMES = {
    PLANNING_PAGE: 'PLANNING',
    CURATING_CONTEXT: 'LOREKEEPING',
    WRITING_OPENING_PAGE: 'WRITING',
    WRITING_CONTINUING_PAGE: 'WRITING',
    ANALYZING_SCENE: 'ANALYZING',
    RESTRUCTURING_STORY: 'RESTRUCTURING',
    RESOLVING_AGENDAS: 'SCHEMING',
  };

  // ── Choice / Delta enums and label maps ──────────────────────────

  var CHOICE_TYPES = [
    { value: 'TACTICAL_APPROACH', label: 'Method/Tactic' },
    { value: 'MORAL_DILEMMA', label: 'Moral Choice' },
    { value: 'IDENTITY_EXPRESSION', label: 'Define Yourself' },
    { value: 'RELATIONSHIP_SHIFT', label: 'Relationship' },
    { value: 'RESOURCE_COMMITMENT', label: 'Spend/Risk' },
    { value: 'INVESTIGATION', label: 'Investigate' },
    { value: 'PATH_DIVERGENCE', label: 'Change Direction' },
    { value: 'CONFRONTATION', label: 'Confront/Fight' },
    { value: 'AVOIDANCE_RETREAT', label: 'Avoid/Flee' },
  ];

  var PRIMARY_DELTAS = [
    { value: 'LOCATION_CHANGE', label: 'Location' },
    { value: 'GOAL_SHIFT', label: 'Goal' },
    { value: 'RELATIONSHIP_CHANGE', label: 'Relationship' },
    { value: 'URGENCY_CHANGE', label: 'Time Pressure' },
    { value: 'ITEM_CONTROL', label: 'Item' },
    { value: 'EXPOSURE_CHANGE', label: 'Attention' },
    { value: 'CONDITION_CHANGE', label: 'Condition' },
    { value: 'INFORMATION_REVEALED', label: 'Information' },
    { value: 'THREAT_SHIFT', label: 'Danger' },
    { value: 'CONSTRAINT_CHANGE', label: 'Limitation' },
  ];

  var CHOICE_TYPE_LABEL_MAP = {};
  CHOICE_TYPES.forEach(function(ct) { CHOICE_TYPE_LABEL_MAP[ct.value] = ct.label; });

  var PRIMARY_DELTA_LABEL_MAP = {};
  PRIMARY_DELTAS.forEach(function(pd) { PRIMARY_DELTA_LABEL_MAP[pd.value] = pd.label; });

