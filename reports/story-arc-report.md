# `storyArc` Technical Report

## Scope
This report covers how `storyArc` is:
- represented in the domain model and persisted in `story.json`
- prompted and generated by the LLM pipeline
- validated/transformed
- consumed during continuation generation
- constrained by existing tests and implementation notes

Goal: support migration from a single `string` arc to a structured narrative arc model (acts, milestones, etc.) while preserving current LLM-driven generation architecture.

## Executive Summary
`storyArc` is currently a single nullable string on `Story` that is initialized as `null`, usually generated on opening page creation, then passed into continuation prompts as context. Technically, continuation generation can also emit a new `storyArc` (same schema is reused), and the engine will accept and persist non-empty updates. This creates soft drift risk and schema ambiguity.

Core facts:
- Domain type: `storyArc: string | null` (`src/models/story.ts:14`).
- Default value at story creation: `null` (`src/models/story.ts:57`).
- Persisted in `story.json` as `string | null` (`src/persistence/story-repository.ts:25`, `src/persistence/story-repository.ts:44`, `src/persistence/story-repository.ts:67`).
- Opening prompt explicitly asks model to determine the story arc (`src/llm/prompts/opening-prompt.ts:28`).
- Continuation prompt includes arc as context if present (`src/llm/prompts/continuation-prompt.ts:16`, `src/llm/prompts/continuation-prompt.ts:83`).
- CoT system guidance explicitly tells model to plan scenes toward story arc (`src/llm/prompts/system-prompt.ts:123`).
- Response schema still includes `storyArc` for all generations (`src/llm/schemas/openrouter-schema.ts:110`), but it is not required (`src/llm/schemas/openrouter-schema.ts:115`).
- Validation defaults missing `storyArc` to empty string (`src/llm/schemas/validation-schema.ts:64`), then transformer converts empty to `undefined` (`src/llm/schemas/response-transformer.ts:9`, `src/llm/schemas/response-transformer.ts:46`).
- Engine updates story arc on both first and next pages when non-empty and changed (`src/engine/page-service.ts:42`, `src/engine/page-service.ts:109`).

## Data Model and Persistence

### Canonical type
- `Story` includes `storyArc: string | null` (`src/models/story.ts:14`).
- `createStory()` sets it to `null` (`src/models/story.ts:57`).
- Runtime type guard allows either string or null (`src/models/story.ts:90`, `src/models/story.ts:102`).
- Updates happen through `updateStoryArc(story, arc)` which trims input (`src/models/story.ts:116`, `src/models/story.ts:119`).

### `story.json` storage
- `story.json` path is fixed by `getStoryFilePath()` (`src/persistence/file-utils.ts:24`).
- On write, repository serializes `storyArc` directly (`src/persistence/story-repository.ts:44`).
- On read, repository deserializes directly back to model (`src/persistence/story-repository.ts:67`).
- Architectural note in docs identifies `story.json` as containing metadata/global canon/story arc (`CLAUDE.md:107`).

### Observed runtime example
- Local runtime file `stories/9b9c7d41-1f52-441f-9032-31d1ecd5d16a/story.json` contains a long single-string arc:
  - `"storyArc": "Hunt a curse-twisted killer ... discover whether the art is worth what it's turning you into"`

## How `storyArc` Is Prompted to Be Produced

### Opening generation (intended creation point)
- Opening user prompt requirement #5: determine overarching goal/conflict (story arc) (`src/llm/prompts/opening-prompt.ts:28`).
- Few-shot opening example includes populated `storyArc` in assistant JSON (`src/llm/examples.ts:49`).

### Continuation generation (intended consumption point, but schema still permits output)
- Continuation context accepts `storyArc: string | null` (`src/llm/types.ts:42`).
- Prompt includes `STORY ARC` section if arc exists (`src/llm/prompts/continuation-prompt.ts:16`).
- Section is embedded near other continuity context before previous scene/choice (`src/llm/prompts/continuation-prompt.ts:83`).
- Few-shot continuation examples include `STORY ARC` in user message (`src/llm/examples.ts:70`).

### System-level influence
- If CoT mode is enabled (default config), system prompt tells model to plan the scene toward the story arc (`src/llm/prompts/system-prompt.ts:123`).
- Default config enables CoT and strict guidance (`configs/default.json`, `src/config/schemas.ts:28`, `src/config/schemas.ts:42`).

## Generation, Validation, and Transformation Pipeline

### Output contract
- API request always uses one shared structured schema: `STORY_GENERATION_SCHEMA` (`src/llm/generation-strategy.ts:40`).
- Schema includes `storyArc` property (`src/llm/schemas/openrouter-schema.ts:110`) with opening-page-focused description (`src/llm/schemas/openrouter-schema.ts:112`).
- `storyArc` is not in `required`, so model may omit it (`src/llm/schemas/openrouter-schema.ts:115`).

### Runtime validation behavior
- Zod schema defines `storyArc` as optional and defaults to `''` (`src/llm/schemas/validation-schema.ts:64`).
- Transformer trims and maps empty string to `undefined` (`src/llm/schemas/response-transformer.ts:9`, `src/llm/schemas/response-transformer.ts:46`).
- Final interface exposes `storyArc?: string` (`src/llm/types.ts:15`).

### Net effect
- Missing arc and blank arc are effectively normalized to “no update”.
- Non-empty arc on any generation response is considered candidate update by engine.

## Engine Consumption and Mutation Rules

### On first page
- Opening generation called with character/world/tone (`src/engine/page-service.ts:15`).
- If `result.storyArc` is non-empty after trim and differs from current, story gets updated (`src/engine/page-service.ts:42`).

### On continuation pages
- Existing story arc is passed back to LLM context (`src/engine/page-service.ts:76`).
- Same update logic applies: any non-empty changed arc is accepted (`src/engine/page-service.ts:109`).

### Persistence timing
- Story is first saved with `storyArc = null`, then updated after first generation if changed (`src/engine/story-service.ts:29`, `src/engine/story-service.ts:35`).
- During branch generation, story is persisted only when generation changed canon/arc object identity (`src/engine/page-service.ts:148`).

## Test and Design Evidence Relevant to Migration

### Tests confirming expected behavior
- Opening prompt tests assert that prompt requests story arc (`test/unit/llm/prompts.test.ts:60`).
- Continuation prompt tests assert inclusion of `STORY ARC` when present (`test/unit/llm/prompts.test.ts:305`).
- Schema pipeline test confirms default `storyArc` is empty string when omitted (`test/integration/llm/schema-pipeline.test.ts:361`).
- Engine tests verify arc can be updated from generation output (`test/unit/engine/page-service.test.ts:53`, `test/unit/engine/page-service.test.ts:92`).

### Internal design note signaling current limitation
- Brainstorming review notes explicitly call out shared schema for opening + continuation and confusion/waste around continuation `storyArc` output (`brainstorming/improvements-to-prompts.md:384`).

## Current Strengths vs. Gaps

### Strengths
- Arc exists at durable story scope (`story.json`), not per-page noise.
- Arc is fed back into continuation context, so model can align scene planning.
- Pipeline already supports optional/missing fields gracefully.

### Gaps / risks
- Shared output schema makes continuation arc emission legal, even though conceptually arc should usually be established at opening and then tracked deliberately.
- Arc is unstructured free text, so no machine-checkable progression state (acts, milestones, escalation, reversals).
- No explicit invariants about arc lifecycle (e.g., immutable after opening vs. revision protocol).
- No explicit UI/engine surface for “progress against arc”; it is prompt context only.

## Migration Blueprint: String Arc -> Structured Narrative Arc

## Proposed target model (high-level)
Introduce `storyArc` as structured object (example shape):
- `premise` (string)
- `centralConflict` (string)
- `acts` (array)
- `act` item fields: `name`, `objective`, `stakes`, `entryCriteria`, `exitCriteria`
- `milestones` (array): id/title/description/status
- `currentActIndex` (number)
- `revisionPolicy` metadata (e.g., `lockedAfterPage`, `allowAdaptiveReframes`)

Keep backward compatibility temporarily via union/migration:
- old: `string | null`
- transitional: `string | StructuredArc | null`
- final: `StructuredArc | null`

## Code areas that will need change

### 1. Models
- `src/models/story.ts`
  - Replace/extend `storyArc` type.
  - Update validators and `updateStoryArc` semantics (possibly separate `initializeStoryArc` and `advanceStoryArcProgress`).

### 2. Persistence
- `src/persistence/story-repository.ts`
  - Update `StoryFileData.storyArc` type.
  - Add migration handling when loading legacy string arcs.

### 3. LLM contracts
- `src/llm/schemas/openrouter-schema.ts`
- `src/llm/schemas/validation-schema.ts`
- `src/llm/schemas/response-transformer.ts`
- Split opening vs continuation response schemas:
  - opening schema includes full structured arc required
  - continuation schema excludes full arc generation, includes optional `arcProgressUpdate` payload only

### 4. Prompting
- `src/llm/prompts/opening-prompt.ts`
  - Ask for full structured arc object.
- `src/llm/prompts/continuation-prompt.ts`
  - Provide structured arc + current act + pending milestones.
  - Ask for progress update/event impacts, not full arc rewrite.
- `src/llm/examples.ts`
  - Update few-shot examples to reflect new structure and continuation update discipline.

### 5. Engine logic
- `src/engine/page-service.ts`
  - Replace current “if non-empty string then overwrite” with explicit progress merge logic.
  - Enforce invariants: allowed fields to mutate on continuation.

### 6. Tests
- Update all mocks and schema tests touching `GenerationResult` and `Story`.
- Existing guidance in repo warns interface changes require broad mock updates (see `CLAUDE.md:182`).

## Suggested incremental rollout
1. Add structured arc types + load-time migration from legacy string.
2. Add dual-schema LLM pipeline (opening vs continuation) behind feature flag.
3. Update prompts/examples and engine merge logic.
4. Add regression tests for:
   - opening produces valid structured arc
   - continuation cannot replace full arc accidentally
   - progression updates only allowed fields
   - legacy `story.json` string arc migrates safely
5. Remove legacy string path after confidence window.

## Key design decisions for deep research
Use these as explicit questions for external LLM deep research:
- Should arcs be immutable after opening, or revisable under strict policy?
- How many acts should be generated by default (3 vs variable)?
- Should milestones be branch-shared or branch-specific?
- Should continuation return deterministic “progress deltas” vs narrative-scored confidence?
- What invariants best prevent arc drift while preserving player agency?

## Appendix: Direct References
- `src/models/story.ts:14`
- `src/models/story.ts:57`
- `src/models/story.ts:116`
- `src/persistence/story-repository.ts:25`
- `src/persistence/story-repository.ts:44`
- `src/persistence/story-repository.ts:67`
- `src/persistence/file-utils.ts:24`
- `src/engine/page-service.ts:42`
- `src/engine/page-service.ts:76`
- `src/engine/page-service.ts:109`
- `src/engine/story-service.ts:35`
- `src/llm/prompts/opening-prompt.ts:28`
- `src/llm/prompts/continuation-prompt.ts:16`
- `src/llm/prompts/continuation-prompt.ts:83`
- `src/llm/prompts/system-prompt.ts:123`
- `src/llm/schemas/openrouter-schema.ts:110`
- `src/llm/schemas/openrouter-schema.ts:115`
- `src/llm/schemas/validation-schema.ts:64`
- `src/llm/schemas/response-transformer.ts:46`
- `src/llm/generation-strategy.ts:40`
- `src/llm/examples.ts:49`
- `test/unit/llm/prompts.test.ts:60`
- `test/unit/llm/prompts.test.ts:305`
- `test/unit/engine/page-service.test.ts:53`
- `test/integration/llm/schema-pipeline.test.ts:361`
- `brainstorming/improvements-to-prompts.md:384`
- `CLAUDE.md:107`
- `CLAUDE.md:182`
